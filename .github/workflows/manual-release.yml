name: ğŸ¯ Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.7)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional, leave empty to auto-generate)'
        required: false
        type: string
      is_prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

jobs:
  manual-release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate version format
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼è¯·ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ (å¦‚: 0.1.7)"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬å·æ ¼å¼æœ‰æ•ˆ: $VERSION"

      - name: ğŸ“ Update manifest.json
        id: update_manifest
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # å¤‡ä»½åŸæ–‡ä»¶
          cp manifest.json manifest.json.bak

          # æ›´æ–°ç‰ˆæœ¬å·
          jq ".version = \"$VERSION\"" manifest.json > manifest.json.tmp
          mv manifest.json.tmp manifest.json

          echo "old_version=$(jq -r '.version' manifest.json.bak)" >> $GITHUB_OUTPUT
          echo "new_version=$VERSION" >> $GITHUB_OUTPUT

          echo "âœ… manifest.json ç‰ˆæœ¬æ›´æ–°: $(jq -r '.version' manifest.json.bak) â†’ $VERSION"

      - name: ğŸ“ Generate Release Notes
        id: generate_notes
        run: |
          THEME_NAME=$(jq -r '.name' manifest.json)
          VERSION="${{ github.event.inputs.version }}"
          CUSTOM_NOTES="${{ github.event.inputs.release_notes }}"

          if [ -n "$CUSTOM_NOTES" ]; then
            # ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å‘å¸ƒè¯´æ˜
            cat > /tmp/release_body.md << EOF
          ## ğŸ‰ $THEME_NAME v$VERSION

          ### ğŸ“ æ›´æ–°è¯´æ˜

          $CUSTOM_NOTES

          ### ğŸ“¦ åŒ…å«æ–‡ä»¶

          - \`theme.css\` - ä¸»é¢˜æ ·å¼æ–‡ä»¶
          - \`manifest.json\` - ä¸»é¢˜é…ç½®

          ### ğŸ”— å¿«é€Ÿä½¿ç”¨

          1. ä¸‹è½½ \`theme.css\`
          2. åœ¨ Obsidian è®¾ç½® â†’ å¤–è§‚ â†’ ä¸»é¢˜ â†’ ç®¡ç† â†’ æ‰‹åŠ¨å®‰è£…ä¸»é¢˜
          3. é€‰æ‹©å¹¶åº”ç”¨ä¸»é¢˜

          ---

          *å‘å¸ƒäº $(date '+%Y-%m-%d %H:%M:%S')*
          EOF
          else
            # è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜ï¼ˆåŸºäºæœ€è¿‘çš„æäº¤ï¼‰
            git fetch --unshallow 2>/dev/null || true

            # è·å–æœ€è¿‘çš„æ ‡ç­¾
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

            if [ -n "$LAST_TAG" ]; then
              CHANGES=$(git log --pretty=format:"- %s" "$LAST_TAG"..HEAD 2>/dev/null || git log --pretty=format:"- %s" -5)
            else
              CHANGES=$(git log --pretty=format:"- %s" -10)
            fi

            if [ -z "$CHANGES" ]; then
              CHANGES="- ä¼˜åŒ–å’Œæ”¹è¿›"
            fi

            cat > /tmp/release_body.md << EOF
          ## ğŸ‰ $THEME_NAME v$VERSION

          ### âœ¨ æœ¬æ¬¡æ›´æ–°å†…å®¹

          $CHANGES

          ### ğŸ“¦ åŒ…å«æ–‡ä»¶

          - \`theme.css\` - ä¸»é¢˜æ ·å¼æ–‡ä»¶
          - \`manifest.json\` - ä¸»é¢˜é…ç½®

          ### ğŸ”— å¿«é€Ÿä½¿ç”¨

          1. ä¸‹è½½ \`theme.css\`
          2. åœ¨ Obsidian è®¾ç½® â†’ å¤–è§‚ â†’ ä¸»é¢˜ â†’ ç®¡ç† â†’ æ‰‹åŠ¨å®‰è£…ä¸»é¢˜
          3. é€‰æ‹©å¹¶åº”ç”¨ä¸»é¢˜

          ---

          *å‘å¸ƒäº $(date '+%Y-%m-%d %H:%M:%S')*
          EOF
          fi

          # è¯»å–åˆ°ç¯å¢ƒå˜é‡
          echo "body<<EOF" >> $GITHUB_ENV
          cat /tmp/release_body.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ” Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: ğŸ·ï¸ Create and Push Tag
        id: create_tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG_NAME="v$VERSION"

          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ æ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨ï¼Œå°†è¦†ç›–"
            git tag -f -a "$TAG_NAME" -m "Release $TAG_NAME"
          else
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          fi

          git push origin "$TAG_NAME" --force
          echo "âœ… æ ‡ç­¾ $TAG_NAME å·²åˆ›å»ºå¹¶æ¨é€"

      - name: ğŸ“¦ Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: Release v${{ github.event.inputs.version }}
          body: ${{ env.body }}
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}

      - name: ğŸ“¤ Upload Theme Files
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./theme.css
          asset_name: theme.css
          asset_content_type: text/css

      - name: ğŸ“¤ Upload Manifest
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./manifest.json
          asset_name: manifest.json
          asset_content_type: application/json

      - name: ğŸ“¤ Upload Package.json (Optional)
        if: success()
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./package.json
          asset_name: package.json
          asset_content_type: application/json

      - name: ğŸ‰ Notify Completion
        if: success()
        run: |
          echo ""
          echo "========================================"
          echo "âœ… æ‰‹åŠ¨å‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "========================================"
          echo "ğŸ“¦ ç‰ˆæœ¬: v${{ github.event.inputs.version }}"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
          echo "ğŸ·ï¸ Tag: v${{ github.event.inputs.version }}"
          echo "ğŸ“¦ Prerelease: ${{ github.event.inputs.is_prerelease }}"
          echo "========================================"

      - name: âŒ Notify Failure
        if: failure()
        run: |
          echo "âŒ å‘å¸ƒå¤±è´¥ï¼è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚"
          exit 1
